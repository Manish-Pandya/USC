<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="../../../../Scripts/jquery-3.1.1.min.js"></script>
   <!--<script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk=" crossorigin="anonymous"></script>-->
    <script src="../../js/lib/angular.js"></script>
    <script src="../../js/constants.js"></script>
    <script src="../../../../Scripts/promise.min.js"></script>
    <script src="../../../../Scripts/lodash.min.js"></script>
    <script src="../client-side-framework/DataStoreManager.js"></script>
    <script src="../client-side-framework/InstanceFactory.js"></script>
    <script src="../client-side-framework/UrlMapping.js"></script>
    <script src="../client-side-framework/XHR.js"></script>
    <script src="../client-side-framework/models/FluxCompositerBase.js"></script>
    <script src="../../client-side-framework/genericModel/inheritance.js"></script>
    <script src="../../client-side-framework/genericModel/genericModel.js"></script>
    <script src="../../client-side-framework/genericModel/genericPrincipalInvestigator.js"></script>
    <script src="../client-side-framework/models/User.js"></script>
    <script src="../client-side-framework/models/Role.js"></script>
    <script src="../client-side-framework/models/PrincipalInvestigator.js"></script>
    <script src="../client-side-framework/models/Room.js"></script>
    <script>

        var classNames = InstanceFactory.getClassNames("/client-side-framework/models");
        //console.log("approved classNames:", classNames);
        
        var currentRoles;
        function getCurrentRoles() {
            if (!currentRoles) {
                return XHR.GET("getCurrentRoles").then((roles) => {currentRoles = roles; })
            } else {
                return new Promise(resolve, reject).then(() => { return resolve(currentRoles)})
            }
        }
        
        var init = function () {
            console.log(currentRoles);
            var users = [],
            hazards = [],
            pis = [],
            rooms = [],
            piSingle = {};

            var firstPI = {};
            firstPI = DataStoreManager.getById("PrincipalInvestigator", 1, firstPI, true)
            .then(
                function (whateverGotReturned) {
                    console.log(firstPI, whateverGotReturned);
                }
            )
            .catch(
                function (reason) {
                    console.log("bad getById:", reason);
                }
            );

            var testEditingUser = function () {
                pis[0].User.Email = "some@email.foo";
                console.log(pis[0].User);
                //var user = DataStoreManager.getActualModelEquivalent(pis[0].User);
                console.log(user);
                console.log(pis[0].User);
            }

            var ps = [DataStoreManager.getAll("Room", rooms, true), DataStoreManager.getAll("PrincipalInvestigator", pis, true)];
            Promise.all(ps)
                .then(
                    function (whateverGotReturned) {
                        //console.log(whateverGotReturned);
                        pis = whateverGotReturned[1];
                        pis[0].Inspection_notes = "dude looks like a lady, but even more fool";

                        var lp = new window.User();
                        lp.Name = "Tronald Dump";
                        pis[0].LabPersonnel.push(lp);

                        //DataStoreManager.undo(pis[0]);
                        console.log(DataStoreManager.getActualModelEquivalent(pis[0]), pis[0]);
                        /*
                        DataStoreManager.save(pis[0]).then((savedJunk) => {
                            console.log(pis[0], pis);
                        });
                        */
                    }
                )//.then(testEditingUser)
                .catch(
                    function (reason) {
                        console.log("bad Promise.all:", reason);
                    }
                );

            var relevantMaps = InstanceFactory.createInstance("PrincipalInvestigator").getCompMapFromProperty("Rooms");
            console.log(relevantMaps);
        }

        getCurrentRoles().then(init);
    </script>
</head>
<body>
</body>
</html>
