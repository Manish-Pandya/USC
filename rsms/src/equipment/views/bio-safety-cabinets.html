<div cg-busy="{promise:loading, message:'Loading', backdrop:true,templateUrl:'../client-side-framework/busy-templates/full-page-busy.html'}"></div>
<div cg-busy="{promise:Saving, message:'BioSafetyCabinetSaving', backdrop:true,templateUrl:'../client-side-framework/busy-templates/full-page-busy.html'}"></div>

<div class="right-column">
    <h1 class="card full bio-safety-cabinets">
        <i class="icon-cabinet"></i>Biological Safety Cabinets
        <select ng-options="certYear as certYear for certYear in certYears | orderBy:'toString()'" ng-model="selectedCertificationDate">
            <option value="">All</option>
            <option value="UNCERTIFIED">Uncertified cabinets</option>
        </select>
        <a ng-click="showInactive = !showInactive" class="btn left" style="margin-left:10px">{{showInactive ? 'Show Active' : 'Show Inactive'}}</a>
        <a ng-click="openModal(null, null, true)" class="btn left" style="margin-left:10px"><i class="icon-plus-2"></i>Add Cabinet</a>
    </h1>
    <h2 ng-if="!cabinets.length">No Cabinets</h2>
    <div ng-repeat="campus in campuses | orderBy: 'Name'" ng-show="cabinets.length && completeCabinets.length || selectedBuilding">
        <div class="full bio-safety-cabinets-container" style="padding:5px;">
            <h2>{{selectedCertificationDate || 'All'}} Certification Records -- {{campus.Name}}</h2>
            <table class="table table-striped table-bordered" >
                <tr class="table-header">
                    <th>EDIT</th>
                    <th>TYPE</th>
                    <th>SERIAL #</th>
                    <th>MAKE</th>
                    <th>MODEL</th>
                    <th>
                        <ul>
                            <li>
                                BUILDING<br>
                                <input ng-model="selectedBuilding" style="width:150px;" placeholder="Filter by Building" />
                            </li>
                            <li>
                                ROOM
                            </li>
                            <li>
                                CERT-DATE
                            </li>
                            <li>
                                DUE-DATE
                            </li>
                            <li>
                                INVESTIGATOR
                            </li>
                            <li>
                                STATUS
                            </li>
                            <li>
                                REPORT
                            </li>
                        </ul>
                    </th>
                    <th>
                        COMMENTS
                    </th>
                </tr>
                <!-- the following filter grabs cabinet inspections that have a Certification_date, stripping those with no Certification_date set: matchEquipmentDate:'':'Certification_date' -->
                <tr ng-repeat="cabinet in completeCabinets = (cabinets | matchEquipmentBuilding:selectedBuilding | matchEquipmentDate:selectedCertificationDate:['Certification_date','Due_date']:currentYearString | matchEquipmentCampus:campus.Key_id | filter:{Is_active: !showInactive}) track by $index">
                    <td>
                        <button ng-disabled="cabinet.edit" ng-class="{'disabled':cabinet.edit}" ng-click="openModal(cabinet, inspections[0], true)" class="btn btn-primary btn-mini left"><i class="icon-pencil"></i></button>
                        <button ng-disabled="cabinet.edit" ng-class="{'disabled':cabinet.edit}" ng-click="deactivate(cabinet)" class="btn btn-danger btn-mini left"><i class="icon-remove"></i></button>
                    </td>
                    <td>
                        {{cabinet.Type}}
                    </td>
                    <td>
                        {{cabinet.Serial_number}}
                    </td>
                    <td>
                        {{cabinet.Make}}
                    </td>
                    <td>
                        {{cabinet.Model}}
                    </td>
                    <td watch="inspections.length" otherwatch="completeCabinets.length" class="asdful-table-heights">
                        <ul ng-repeat="inspection in inspections = (cabinet.EquipmentInspections | matchInspectionDate:selectedCertificationDate:currentYearString | orderBy:'Due_date':true)">
                            <li>
                                {{inspection.Room.Building.Name}}
                            </li>
                            <li>
                                {{inspection.Room.Name}}
                            </li>
                            <li>
                                {{inspection.Certification_date | dateToISO}}
                            </li>
                            <li>
                                {{inspection.Due_date | dateToISO}}
                            </li>
                            <li>
                                {{inspection.PrincipalInvestigator.User.Name}}
                            </li>
                            <li>
                                <span class="bold" ng-class="{'red': inspection.Status == constants.BIOSAFETY_CABINET.STATUS.FAIL || inspection.Status == constants.BIOSAFETY_CABINET.STATUS.OVERDUE,
                                                 'yellow': inspection.Status == constants.BIOSAFETY_CABINET.STATUS.PENDING || inspection.Status == constants.BIOSAFETY_CABINET.STATUS.NEW_BSC,
                                                 'green': inspection.Status == constants.BIOSAFETY_CABINET.STATUS.PASS }">{{inspection.Status}}</span>
                            </li>
                            <li>
                                <a style="margin-top:-24px" ng-if="inspection.Report_path" ng-disabled="!inspection.Report_path" href="../protocol-documents/{{inspection.Report_path}}" target="_blank" class="btn btn-success left">Report</a>
                                <a style="margin-top:-24px" ng-if="!inspection.Report_path" disabled="disabled" class="btn btn-success left">Report</a>
                                <a ng-class="{'disabled':inspection.edit}" ng-click="openModal(cabinet, inspection)" class="btn btn-primary left"><i ng-class="{'icon-pencil':inspection.Certification_date,'icon-checkmark':!inspection.Certification_date}"></i>Certify</a>
                            </li>
                        </ul>
                    </td>
                    <td>
                        {{cabinet.Comments}}
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>