<form class="access-request">
    <div class="well">
        <h3 class="auth-form-header">RSMS Request for User Access</h3>

        <div class="overlay-container fadein" ng-show="!data.pending_requests.length">
            <div class="overlay" ng-if="data.selection.submitting && !data.selection.submission_complete">
                <i class="icon-spinnery-dealie spinner"></i>
                <span>Submitting Access Request for {{data.selection.username}}...</span>
            </div>

            <div class="overlay" ng-if="data.selection.submitting && data.selection.submission_complete">
                <i class="icon-checkmark"></i>
                <span>Access Request complete</span>
            </div>

            <div class="overlay" ng-if="data.selection.submitting && data.selection.submission_error">
                <i class="icon-cancel"></i>
                <span>An error occurred while processing your Access Request. Please try again later.</span>
                <div>
                    <a class="btn btn-danger" ng-href="{{GLOBAL_WEB_ROOT}}action.php?action=logoutAction">Back to Login</a>
                </div>
            </div>

            <div class="auth-form-fields overlay-container">
                <div class="overlay" ng-if="!data.listing.length">
                    <i class="icon-spinnery-dealie spinner"></i>
                    <span>Loading...</span>
                </div>

                <h5 ng-show="data.listing.length" class="fadein bold">
                    <span>Complete the following form to submit a request for access to <i>RSMS</i>.</span>
                </h5>

                <hr/>

                <div ng-show="data.listing.length" class="card auth-element fadein"
                    ng-class="{ 'selection-made': data.selection.username, 'selection-empty': !data.selection.username }">
                    <h3 class="even-content">
                        <span>Confirm Your Network Username</span>
                        <span class="badge">1/4</span>
                    </h3>
                    <div class="even-content">
                        <pre class="auth-username" once-text="data.candidate.Username"></pre>
                        <div ng-show="!data.selection.username" class="fadein auth-form-footer">
                            <a class="btn btn-success" ng-click="data.selection.username = data.candidate.Username">
                                <i class="icon-checkmark"></i>
                            </a>
    
                            <a class="btn btn-danger" ng-href="{{GLOBAL_WEB_ROOT}}action.php?action=logoutAction">
                                <i class="icon-cancel"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div ng-show="data.listing.length && data.selection.username" class="card auth-element fadein"
                    ng-class="{ 'selection-made': data.selection.department, 'selection-empty': !data.selection.department }">
                    <h3 class="even-content">
                        <span>Select Your Department</span>
                        <span class="badge">2/4</span>
                    </h3>
                    <ui-select ng-model="data.selection.department" theme="selectize" ng-disabled="disabled" on-select="data.selection.pi = null">
                        <ui-select-match placeholder="Select or search for a Department">{{$select.selected.Name}}</ui-select-match>
                        <ui-select-choices repeat="dept in data.listing | filter: {Name:$select.search} | orderBy:'Name'">
                            <span ng-bind-html="dept.Name"></span>
                        </ui-select-choices>
                    </ui-select>
                </div>

                <div ng-show="data.selection.department" class="card auth-element fadein"
                    ng-class="{ 'selection-made': data.selection.pi, 'selection-empty': !data.selection.pi }">
                    <h3 class="even-content">
                        <div>
                            <div>Select Your Principal Investigator</div>
                            <h5 style="font-style: italic;">
                                <strong>Department:</strong>
                                <span>{{data.selection.department.Name}}</span>
                            </h5>
                        </div>

                        <span class="badge">3/4</span>
                    </h3>
                    <ui-select ng-model="data.selection.pi" theme="selectize" ng-disabled="disabled">
                        <ui-select-match placeholder="Select or search for a Principal Investigator">{{$select.selected.Name}}</ui-select-match>
                        <ui-select-choices repeat="pi in data.selection.department.PrincipalInvestigators | filter: $select.search | orderBy:'Name'">
                            <span ng-bind-html="pi.Name"></span>
                        </ui-select-choices>
                    </ui-select>
                </div>

                <hr ng-show="data.selection.pi"/>

                <div ng-show="data.selection.pi" class="card auth-element fadein"
                    ng-class="{ 'selection-made': data.selection.submitting, 'selection-empty': !data.selection.submitting }">
                    <h3 class="even-content">
                        <span>Submit Access Request</span>
                        <span class="badge">4/4</span>
                    </h3>

                    <h5>
                        <span>You are about to request access to <i>RSMS</i> as Laboratory Personnel of <strong><i>{{data.selection.pi.Name}}</i></strong>.</span>
                        <span>Your submitted request will be reviewed by your <i>Principal Investigator</i> and you will be notified when it has been completed.</span>
                    </h5>

                    <div class="auth-form-footer">
                        <a ng-click="submitRequest()" class="btn btn-success">Submit Access Request</a>

                        <a class="btn btn-danger" ng-href="{{GLOBAL_WEB_ROOT}}action.php?action=logoutAction">Cancel Request</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="request-status fadein" ng-show="data.candidate.Access_requests.length">
            <hr ng-if="data.pending_requests.length"/>
            <h5 ng-repeat="request in data.pending_requests">
                <span>You submitted a request for access under {{request.Principal_investigator_name}} on {{getDate(request.Date_created) | date:'shortDate'}}.</span>
                <span>This request is being reviewed.</span>
            </h5>

            <a ng-if="data.candidate.Access_requests.length > 1"
               ng-click="data.show_request_history = !data.show_request_history">
               <span>{{ data.show_request_history ? 'Hide' : 'Show'}} request history</span>
            </a>

            <div class="fadein" ng-show="data.show_request_history">
                <h3>Your Requests:</h3>
                <table class="table table-bordered table-hover">
                    <tr>
                        <th>Request Date</th>
                        <th>Principal Investigator</th>
                        <th>Status</th>
                    </tr>
                    <tr ng-repeat="request in data.candidate.Access_requests | orderBy:'-Date_created'">
                        <td>{{getDate(request.Date_created) | date:'shortDate'}}</td>
                        <td>{{request.Principal_investigator_name}}</td>
                        <td>
                            <span class="badge" ng-class="{
                                'badge-success': request.Status == 'APPROVED',
                                'badge-important': request.Status == 'DENIED'
                            }">{{request.Status}}</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</form>
